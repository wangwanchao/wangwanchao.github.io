---
title: QUIC协议在Uber的实践(译)
date: 2020-09-06 10:09:01
tags:
categpries: NetWork
---
[原文](https://eng.uber.com/employing-quic-protocol/)

Uber对全球600多个城市的4500名手机用户做了调查，这些手机全部通过无线连接。为了实现实时的性能，App要求低延迟、高可用的网络通信。在动态的、损失率高的网络环境下，HTTP/2表现较差，最后我们追踪到性能差的主要原因还是基于系统实现的TCP比较差。
为了定位痛点，我们开始尝试使用QUIC协议，QUIC是一种基于UDP实现的流通信协议，我们可以更好的控制传输协议性能，现在已经被IETF采纳为HTTP/3协议标准。
在测试QUIC后，我们发现在App中整合QUIC相比原来的TCP可以降低末端延迟。可以确定在基于HTTPS的rider/driver apps中可以带来10-30%的延迟。除了在低延迟上的性能表现，QUIC提供了`packets流`端到端(end-to-end)的控制，这是基于用户空间层面的
<!-- more -->
## TCP 
在今天的网络中，TCP仍然是HTTPS通信中最广泛使用的通信协议。TCP提供了一种可信的字节流，解决了网络拥塞的复杂性、链路层丢失的问题。HTTPS广泛使用TCP主要还是因为TCP几乎存在于每一个保护TCP协议的系统中，例如负载均衡、HTTPS代理、CDNs，而且TCP在大多数平台、网络中都是开箱即用的。
我们的用户在使用Uber过程中位置是动态的，基于TCP的末端延迟很难满足HTTPS的实时特性。

### 基于无线网络的TCP
TCP最开始是为有线网络设计的，有高可预见的连接。然而无线网络有独特的特性和挑战。
1. 首先，由于干扰、信号衰减，无线网很容易丢失信号。这些都会导致RTTs更高或者变化、丢包。例如：WiFi很容易被微波、蓝牙、其他类型的信号波干扰。蜂窝网因为周围环境建筑物、干扰、附近基站的影响，很容易丢失信号
2. 为了在宽带和丢包中解决间歇的网络抖动问题，蜂窝网使用了更大的缓冲来接收突发流量。更大的buffer导致排队，结果是更长的延迟。由于超时，TCP通常把队列这种情况认为丢失，接着需要重传直到buffer继续被填满，这种问题称为缓存溢出`bufferbloat`。
3. 蜂窝网性能不同的用户、不同区域、不同时间也不一样。
**这个地方图片就不展示了，大家都体验过**
以上这些问题都归结于TCP的低效性，在深入理解TCP之前，我们先思考以下3个问题：
1. TCP是手机端用户末端延迟的主要原因吗？
2. 目前网络RTT、丢包是否变化很大？
3. 什么因素对TCP中RTT变化、丢包影响较大？

### TCP性能分析
为了更好地理解我们是怎么分析TCP性能的，首先简单介绍以下TCP通信过程：
1. 首先，发送端建立三次握手
2. 建立TLS连接：2-3个的round trips


在这种情况下，packet丢失、或者ACK丢失，重传机制超时(RTO)后，发送端发起重传，RTO是根据不同的因素动态计算的：发送端和接收端的RTT估值。
为了分析TCP性能，我们使用tcpdump收集了印度市场一周内的网络连接情况，然后使用tcptrace进行了分析。除此之外，我们使用app发送请求到测试环境模拟了真实的情况，同时打印上传日志到服务器，然后部署到印度的应用市场。
无论是tapdump分析，还是日志分析，这两种分析结果都是一致的。RTT值、末端延迟几乎是中值的6倍，中值比平均值多1s。除此之外，包丢失严重，导致3.5%的重传率。在用户多的地方，丢失率甚至达到7%，例如火车站、机场。
相比数据包，对重传SYN、SYN-ACK包，TCP使用了非常保守的RTO值。大多数TCP都使用RTO=1s的初始值，随着包丢失的问题RTO以指数级增长。
数据包传输时，在无线网络下，更高的RTO导致网络可用时间更少。我们发现平均重传时间大约是1s，末端时间甚至可以达到30s，这种高延迟导致HTTPS超时、重试，从而导致更大的延迟，恶性循环。

## QUIC
基于QUIC的HTTP/2被定义为HTTP/3，她取代了HTTPS和TCP协议栈中的一些层，而且QUIC只支持安全数据传输，TLS协议被完全嵌套在QUIC协议中。
以下就是为什么我们非常强烈的想要在TCP之外引入QUIC的特性：
1.

2. 

3. 


4. 


5.

### QUIC选型的思考
在确定QUIC之前，我们调研了很多方案来提升TCP性能：
1. 


### QUIC在Uber平台的整合


### QUIC在Google Cloud Load Balancers的开关


### 性能分析
#### 阶段一


#### 阶段二

在第二阶段，我们遇到一些有趣的思考：

#### 生产阶段

## 展望未来
在部署QUIC的过程中，无论是强网络还是弱网络，我们已经找到了几种方法来提升APP性能。
### 增加QUIC覆盖率


### QUIC优化


**翻译不好，有问题的地方多多反馈(邮箱：wwangwanchao@126.com)**