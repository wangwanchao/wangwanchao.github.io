---
title: 第五天 + 第六天
date: 2020-10-05 16:23:07
tags:
categpries: OS
mathjax: true
---
难度越来越大了。今天的内容设计的中断表，全局分段表，核心就是GDT和IDT。第五天、第六天内容偏理论性比较多，结合放在一篇博客内。

<!-- more -->

## 汇编
系统中存在多个程序同时运行，如果加载到相同的内存地址，则会导致内存冲突而无法运行。为了解决这个问题就需要用到分段的思想。

### 分段
分段就是把整个内存分成很多块(block)，每一块的起始位置都看作0x0000，然后对应到实际的物理地址。段寄存器DS终于派上用场了。
如何表示一个段？
1. 段的大小是多少
2. 段对应的物理起始位置
3. 段的权限(禁止写入，禁止执行，系统专用等)

原理：
CPU表示一个段需要8字节，DS为16位，实际上为了兼容，能用的只有13位，所以能表示的段有$ 2^13 = 8192 $个段，表示这些段需要$ 8192 * 8 = 64KB $，显然CPU不具备存储这么多数据的条件，而是放在内存中，这就是GDT(全局段号记录表)，这块内存的起始地址放在CPU的特殊寄存器GDTR内。

段上限：表示一个段有多少个字节，用low(2)+mid(1)+mid(1)共4个字节表示。最大表示4GB需要4B，加上基地址4B，总共需要8B，段上限只保留20位，2^20 = 1MB，通过将段属性一个位设置为1，段上限的单位解释为页，1页是4KB，这样 1MB * 4KB = 4GB。这20位用low 2个字节和high的高4位表示。

段的访问属性：使用剩余的12位表示，`xxxx0000 xxxxxxxxx`，高4位0给段上限使用，低4位使用`GD00`表示，D-段上限的Gbit，D-段的模式，1是32位模式，0是16位模式。
| bit位 | 用途 | 权限 |
|:-|:-:|:-:|
| 0x00 | 未使用的记录表| - |
| 0x92 | 系统专用 | 可读，可写，不可执行 |
| 0x9a | 系统专用 | 可读，不可写，可执行 |
| 0xf2 | 应用程序用 | 可读，可写，不可执行 |
| 0xfa | 应用程序用 | 可读，不可写，可执行 |


### 分页


## 中断
IDR: 中断记录表。记录中断号和处理函数的对应关系。
### PIC 
IRQ: interrupt request。
PIC: 可中断编程控制器。CPU单独只能处理一个中断，主板通过增加几个辅助芯片组成芯片组。PIC是将8个中断信号集合成一个中断信号的装置。主PIC和CPU直连，从PIC连接在主PIC的IRQ2上。
PIC内部有很多寄存器，通过端口号进行区分写入哪一个寄存器。即便端口相同，也可以通过规则区分：先写入ICW1，接着写入ICW2。
IMR: interrupt mask register 中断屏蔽寄存器。8位分别对应8路IRQ，如果某一位的值置为1，则该位对应的IRQ信号被屏蔽，PIC就忽视该信号。
ICW: initial control word 初始化控制数据。总共有4个，编号为1~4。
> ICW1和ICW4
> ICW3
> ICW2: 决定IRQ以哪一号中断通知CPU。不同的操作系统可以单独设定。